# This workflow uses actions that are not certified by GitHub.
# They are provided by a third-party and are governed by
# separate terms of service, privacy policy, and support
# documentation.

# This workflow lets you compile your Go project using a SLSA3 compliant builder.
# This workflow will generate a so-called "provenance" file describing the steps
# that were performed to generate the final binary.
# The project is an initiative of the OpenSSF (openssf.org) and is developed at
# https://github.com/slsa-framework/slsa-github-generator.
# The provenance file can be verified using https://github.com/slsa-framework/slsa-verifier.
# For more information about SLSA and how it improves the supply-chain, visit slsa.dev.

name: SLSA Go releaser
on:
  workflow_dispatch:
  push:
    branches: [main, master]

# Prevent concurrent releases - only one release workflow should run at a time
concurrency:
  group: slsa-release-${{ github.ref }}
  cancel-in-progress: false

# Grant broad permissions so the reusable workflow's detect-env job can get OIDC token
# and call Actions API (get workflow run). If you still see "Resource not accessible by integration"
# or "No repository detected", enable: Repo → Settings → Actions → General →
# Workflow permissions → "Read and write permissions".
permissions:
  id-token: write
  contents: write
  actions: read

jobs:
  # ========================================================================================================================================
  #     Prerequesite: Create a .slsa-goreleaser.yml in the root directory of your project.
  #       See format in https://github.com/slsa-framework/slsa-github-generator/blob/main/internal/builders/go/README.md#configuration-file
  #=========================================================================================================================================
  build:
    permissions:
      id-token: write # To sign.
      contents: write # To upload release assets.
      actions: read   # To read workflow path (needed by detect-workflow-js in reusable workflow).
    uses: slsa-framework/slsa-github-generator/.github/workflows/builder_go_slsa3.yml@v2.1.0
    with:
      go-version: 1.22
      # Allow private repos to post to the public transparency log (repo name will be visible).
      private-repository: true
      # Upload binary + provenance to a GitHub release.
      upload-assets: ${{ github.event_name != 'pull_request' }}
      # On push to main/master: create release with version v0.0.0.<run_number>. On release event: use the created tag.
      upload-tag-name: ${{ github.event_name == 'release' && github.event.release.tag_name || (github.event_name == 'push' || github.event_name == 'workflow_dispatch') && format('v0.0.0.{0}', github.run_number) || '' }}
      # =============================================================================================================
      #     Optional: For more options, see https://github.com/slsa-framework/slsa-github-generator#golang-projects
      # =============================================================================================================
